---
import BaseLayout from "../layouts/BaseLayout.astro";
import BackLink from "../components/BackLink.astro";
import type { CollectionEntry } from "astro:content";
import { Image } from "astro:assets";

type Props = CollectionEntry<"blog">["data"];

const {
  title,
  description,
  foundry,
  foundryLink,
  downloadLink,
  gallery,
  preview,
  license,
  styles,
  features,
  variable,
} = Astro.props;

// count the amount of features and make a new variable with the amount
const featureAmount = features.length;

const slug = title.toLowerCase().replace(/\s/g, "-");
const id = title.toLowerCase().replace(/\s/g, "-");
const { default: svg } = await import(
  `../svg/${slug}/gallery/${slug}-1.svg?raw`
);

// remove the https:// from the foundry link
const foundryLinkShort = foundryLink.replace(/(^\w+:|^)\/\//, "");
const downloadLinkShort = downloadLink.replace(/(^\w+:|^)\/\//, "");

// import all the objects from the gallery prop

// get all the svg files in the gallery folder of the slug folder
// const gallery = await Astro.glob(`../svg/${slug}/gallery/*.svg`);
---

<style is:global>
  .gallery {
    /* display: flex;
    align-items: center;
    justify-content: center; */
    /* flex-direction: column; */
    gap: var(--global-space-m);
  }

  .gallery__item {
    display: none;
    align-items: center;
    justify-content: center;
  }

  .gallery__item:first-child {
    display: flex;
  }

  .gallery__item.active {
    display: flex;
  }

  .gallery__item.inactive {
    display: none;
  }

  .gallery__img {
    /* width: 100%; */
    /* height: auto; */
    height: calc(100vh - var(--global-space-m) * 2);
    width: auto;
  }

  .gallery__buttons {
    display: flex;
    gap: var(--global-space-s);
  }

  .gallery__amount {
    font-feature-settings: "tnum";
  }

  .gallery__button {
    flex-basis: 100%;
    flex-grow: 1;
    height: 1px;
    background-color: hotpink;
  }

  .features {
    display: flex;
    flex-wrap: wrap;
    /* gap: 0 var(--global-space-xs); */
    /* font-size: calc(13 / var(--global-fontSize) * 1rem); */
    font-family: var(--global-fontFamily-mono);
    /* line-height: 1; */
    /* font-weight: 84; */
    font-feature-settings: "zero";
  }

  * + .features {
    margin-top: var(--global-space-xxs);
  }

  .features__item {
    background-color: var(--global-foregroundColor);
    padding: calc(var(--global-space-xxs) + 1px) var(--global-space-xs)
      calc(var(--global-space-xxs) + 2px);
    border-radius: var(--global-borderRadius-s);
    /* border-radius: 4rem; */
  }

  .table {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    /* grid-auto-flow: row dense; */
    /* grid-template-rows: masonry; */
    gap: var(--global-space-m) var(--global-space-xl);
    /* column-count: 2; */

    /* column-width: 30em;
    gap: var(--global-space-xl); */

    /* @media (--medium-viewport) { */
    /* grid-template-columns: max-content 1fr; */
    /* } */
  }

  .table__row {
    /* margin-bottom: var(--global-space-m);
    break-inside: avoid; */

    display: grid;
    grid-column: 1/-1;
    grid-template-columns: subgrid;

    & + & {
      padding-top: var(--global-space-m);
      border-top: 1px solid var(--global-borderColor);
    }

    & dt {
      color: var(--global-meta-color);
      /* justify-self: end; */
    }

    & dd {
      max-width: 36em;
    }
  }
</style>

<script>
  const initGallery = () => {
    const gallery = document.querySelector(".gallery");
    const galleryContainer = document.querySelector(".gallery__container");
    const galleryItems = document.querySelectorAll(".gallery__item");
    const galleryAmount = document.querySelector(".gallery__amount");
    const buttons = document.querySelector(".gallery__buttons");

    let current = 0;
    let next = 1;
    let prev = galleryItems.length - 1;

    const nextSlide = () => {
      galleryItems[current].classList.remove("active");
      galleryItems[current].classList.add("inactive");
      galleryItems[next].classList.add("active");
      galleryItems[next].classList.remove("inactive");
      current = next;
      next = current + 1;
      prev = current - 1;
      if (next === galleryItems.length) {
        next = 0;
      }
      if (prev === -1) {
        prev = galleryItems.length - 1;
      }
    };

    const prevSlide = () => {
      galleryItems[current].classList.remove("active");
      galleryItems[current].classList.add("inactive");
      galleryItems[prev].classList.add("active");
      current = prev;
      next = current + 1;
      prev = current - 1;
      if (next === galleryItems.length) {
        next = 0;
      }
      if (prev === -1) {
        prev = galleryItems.length - 1;
      }
    };

    galleryItems.forEach((item, index) => {
      if (index === 0) {
        item.classList.add("active");
      }

      // add a button to the gallery element for each item
      const button = document.createElement("button");
      button.classList.add("button-reset");
      button.classList.add("gallery__button");
      button.setAttribute("aria-label", `Show image ${index + 1}`);
      button.setAttribute("aria-controls", `image-${index + 1}`);
      button.setAttribute("aria-selected", "false");
      button.setAttribute("type", "button");
      button.setAttribute("id", `button-${index + 1}`);
      button.innerHTML = `<span class="sr-only">Show image ${index + 1}</span>`;

      buttons.appendChild(button);

      // add a click event to each button
      button.addEventListener("click", () => {
        galleryItems.forEach((item) => {
          item.classList.remove("active");
          item.classList.add("inactive");
        });
        galleryItems[index].classList.add("active");
        galleryItems[index].classList.remove("inactive");
        current = index;
        next = current + 1;
        prev = current - 1;
        GalleryAmount();
      });
    });

    // make a function to add and change the amount of images to the gallery in the form of 1/3 to use in nextSlide and prevSlide
    const GalleryAmount = () => {
      galleryAmount.innerHTML = `${current + 1}/${galleryItems.length}`;
    };

    GalleryAmount();

    // update gallery amount when nextSlide or prevSlide is called

    galleryContainer.addEventListener("click", () => {
      GalleryAmount();
      nextSlide();
    });
  };

  // initGallery();

  document.addEventListener("astro:after-swap", () => {
    // initGallery();
  });
</script>

<BaseLayout title={title} description={description}>
  <BackLink />
  <main class="detail">
    <header class="detail__intro">
      <h1 class="detail__img">
        <span class="sr-only">{title}</span>
        <Image src={preview} alt={title} />
      </h1>
      {
        /*
      <div class="gallery">
        <div class="gallery__container">
          {
            gallery.map((item) => (
              <div class="gallery__item">
                <Image class="gallery__img" src={item} alt={title} />
              </div>
            ))
          }
        </div>
        <div class="gallery__ui">
          <div class="gallery__buttons" role="tablist"></div>
          <div class="gallery__amount"></div>
        </div>
      </div>
      */
      }
      <!-- <div class="detail__header">
        <h1 class="detail__title font-size-l">{title}</h1>
      </div> -->
    </header>
    <div class="detail__body">
      <dl class="table">
        <div class="table__row">
          <dt>Info</dt>
          <dd>{description}</dd>
        </div>
        <div class="table__row">
          <dt>By</dt>
          <dd><a href={foundryLink}>{foundry}</a></dd>
        </div>
        <div class="table__row">
          <dt>Family</dt>
          <dd>
            {styles}&nbsp;{styles === 1 ? "style" : "styles"}&nbsp;{
              variable ? "+ variable" : ""
            }
          </dd>
        </div>
        <div class="table__row">
          <dt>Features</dt>
          <dd>
            <ul class="list-reset features">
              {
                features.map((feature) => (
                  <li>
                    {feature}&nbsp;
                    {/*feature !== features[features.length - 1] ? "," : ""*/}
                    {/*feature !== features[features.length - 1] ? "," : ""*/}
                  </li>
                ))
              }
            </ul>
          </dd>
        </div>
        <div class="table__row">
          <dt>Download</dt>
          <dd><a href={downloadLink}>{downloadLinkShort}</a></dd>
        </div>
        <div class="table__row">
          <dt>License</dt>
          <dd>{license}</dd>
        </div>
      </dl>
      {
        /*
      <div class="flow">
        <div>
          <h2 class="color-meta">Designed By</h2>
          <p>
            <a href={foundryLink}>{foundry}</a>
          </p>
        </div>
        <div>
          <h2 class="color-meta">Family</h2>
          <p>
            {styles}&nbsp;{styles === 1 ? "style" : "styles"}&nbsp;{
              variable ? "+ variable" : " static"
            }
          </p>
        </div>
        <div>
          <h2 class="color-meta">Licence</h2>
          <p>
            {license}
          </p>
        </div>
        <div>
          <h2 class="color-meta">{featureAmount} features</h2>
          <ul class="list-reset features">
            {
              features.map((feature) => (
                <li class="features__item">{feature}</li>
              ))
            }
          </ul>
        </div>

    </div>
    <div class="flow max-width-m">
      <slot />
      <p>
        <a
          class="download"
          href={downloadLink}
          target="_blank"
          rel="noopener noreferrer"
        >
          Download
        </a>
      </p>
    </div>
            */
      }
    </div>
  </main>
</BaseLayout>
