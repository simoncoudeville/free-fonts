---
import BaseLayout from "../layouts/BaseLayout.astro";
import BackLink from "../components/BackLink.astro";
import Thumb from "../components/Thumb.astro";
import type { CollectionEntry } from "astro:content";
import opentype from "opentype.js";

import fs from "node:fs";
import path from "node:path";

type Props = CollectionEntry<"blog">["data"];

const {
  title,
  description,
  foundry,
  foundryLink,
  downloadLink,
  font,
  license,
  styles,
  variable,
  pubDate,
} = Astro.props;

const slug = title.toLowerCase().replace(/\s/g, "-");

// const svgData = fs.readFileSync(
//   path.resolve(`src/svg/${slug}/thumb.svg`),
//   "utf8"
// );

// const svgPath = path.resolve(`src/svg/${slug}/thumb.svg`);

const fontPath = path.resolve(`src/fonts/${slug}/${font}`);
const buffer = fs.readFileSync(fontPath).buffer;
const fontFile = opentype.parse(await buffer);
const fontData = fontFile.tables;
const tableNames = Object.keys(fontData);
const gsubArray = fontData["gsub"].features;

// get all the keys with the name 'tag' from the gsubArray and put the values in a new array
const fontFeatures = gsubArray.map((key) => key.tag);

// sometimes the fontFeatures array contains values from ss01 to ss20, replace them with a string ss01-ss20 and do the same for cv01 to cv20
let ssAmount = fontFeatures.filter((feature) => feature.includes("ss")).length;
let cvAmount = fontFeatures.filter((feature) => feature.includes("cv")).length;

// rewrite ssAmount and cvAmount as for example 08 if it's 8
ssAmount = ssAmount < 10 ? `0${ssAmount}` : ssAmount;
cvAmount = cvAmount < 10 ? `0${cvAmount}` : cvAmount;

// now replace the cv values with one string cv01-cv20 based on the amount of cv values
if (cvAmount > 0) {
  // add the new string to the array at the index of the first cv value
  fontFeatures.splice(
    fontFeatures.indexOf("cv01"),
    cvAmount,
    `cv01 -> cv${cvAmount}`
  );
}

//now replace the ss values with one string ss01-ss20 based on the amount of ss values
if (ssAmount > 0) {
  // add the new string to the array at the index of the first ss value
  fontFeatures.splice(
    fontFeatures.indexOf("ss01"),
    ssAmount,
    `ss01 -> ss${ssAmount}`
  );
}

// get all the unique values from the fontFeatures array
let uniqueFeatures = [...new Set(fontFeatures)];

const fvarArray = fontData["fvar"].axes;
const fontAxes = fvarArray.map((key) => key.tag);

console.log(fvarArray);

// remove the https:// from the foundry link
const downloadLinkShort = downloadLink.replace(/(^\w+:|^)\/\//, "");

const date = new Date(pubDate).toLocaleDateString("en-UK", {
  year: "numeric",
  month: "short",
  day: "numeric",
});

// import all the objects from the gallery prop

// get all the svg files in the gallery folder of the slug folder
// const gallery = await Astro.glob(`../svg/${slug}/gallery/*.svg`);
---

<style is:global>
  .gallery {
    /* display: flex;
    align-items: center;
    justify-content: center; */
    /* flex-direction: column; */
    gap: var(--global-space-m);
  }

  .gallery__item {
    display: none;
    align-items: center;
    justify-content: center;
  }

  .gallery__item:first-child {
    display: flex;
  }

  .gallery__item.active {
    display: flex;
  }

  .gallery__item.inactive {
    display: none;
  }

  .gallery__img {
    /* width: 100%; */
    /* height: auto; */
    height: calc(100vh - var(--global-space-m) * 2);
    width: auto;
  }

  .gallery__buttons {
    display: flex;
    gap: var(--global-space-s);
  }

  .gallery__amount {
    font-feature-settings: "tnum";
  }

  .gallery__button {
    flex-basis: 100%;
    flex-grow: 1;
    height: 1px;
    background-color: hotpink;
  }

  .svg {
    overflow: visible;
  }
</style>

<script>
  const initGallery = () => {
    const gallery = document.querySelector(".gallery");
    const galleryContainer = document.querySelector(".gallery__container");
    const galleryItems = document.querySelectorAll(".gallery__item");
    const galleryAmount = document.querySelector(".gallery__amount");
    const buttons = document.querySelector(".gallery__buttons");

    let current = 0;
    let next = 1;
    let prev = galleryItems.length - 1;

    const nextSlide = () => {
      galleryItems[current].classList.remove("active");
      galleryItems[current].classList.add("inactive");
      galleryItems[next].classList.add("active");
      galleryItems[next].classList.remove("inactive");
      current = next;
      next = current + 1;
      prev = current - 1;
      if (next === galleryItems.length) {
        next = 0;
      }
      if (prev === -1) {
        prev = galleryItems.length - 1;
      }
    };

    const prevSlide = () => {
      galleryItems[current].classList.remove("active");
      galleryItems[current].classList.add("inactive");
      galleryItems[prev].classList.add("active");
      current = prev;
      next = current + 1;
      prev = current - 1;
      if (next === galleryItems.length) {
        next = 0;
      }
      if (prev === -1) {
        prev = galleryItems.length - 1;
      }
    };

    galleryItems.forEach((item, index) => {
      if (index === 0) {
        item.classList.add("active");
      }

      // add a button to the gallery element for each item
      const button = document.createElement("button");
      button.classList.add("button-reset");
      button.classList.add("gallery__button");
      button.setAttribute("aria-label", `Show image ${index + 1}`);
      button.setAttribute("aria-controls", `image-${index + 1}`);
      button.setAttribute("aria-selected", "false");
      button.setAttribute("type", "button");
      button.setAttribute("id", `button-${index + 1}`);
      button.innerHTML = `<span class="sr-only">Show image ${index + 1}</span>`;

      buttons.appendChild(button);

      // add a click event to each button
      button.addEventListener("click", () => {
        galleryItems.forEach((item) => {
          item.classList.remove("active");
          item.classList.add("inactive");
        });
        galleryItems[index].classList.add("active");
        galleryItems[index].classList.remove("inactive");
        current = index;
        next = current + 1;
        prev = current - 1;
        GalleryAmount();
      });
    });

    // make a function to add and change the amount of images to the gallery in the form of 1/3 to use in nextSlide and prevSlide
    const GalleryAmount = () => {
      galleryAmount.innerHTML = `${current + 1}/${galleryItems.length}`;
    };

    GalleryAmount();

    // update gallery amount when nextSlide or prevSlide is called

    galleryContainer.addEventListener("click", () => {
      GalleryAmount();
      nextSlide();
    });
  };

  // initGallery();

  document.addEventListener("astro:after-swap", () => {
    // initGallery();
  });
</script>

<BaseLayout title={title} description={description}>
  <BackLink />
  <main class="detail">
    <header class="detail__intro">
      <h1 class="detail__img">
        <span class="sr-only">{title}</span>
        <!-- <Image src={preview} alt={title} /> -->
        <!-- <Fragment set:html={svg} /> -->
        <Thumb slug={slug} title={title} font={font} />
      </h1>
      {
        /*
      <div class="gallery">
        <div class="gallery__container">
          {
            gallery.map((item) => (
              <div class="gallery__item">
                <Image class="gallery__img" src={item} alt={title} />
              </div>
            ))
          }
        </div>
        <div class="gallery__ui">
          <div class="gallery__buttons" role="tablist"></div>
          <div class="gallery__amount"></div>
        </div>
      </div>
      */
      }
      <!-- <div class="detail__header">
        <h1 class="detail__title font-size-l">{title}</h1>
      </div> -->
    </header>
    <div class="detail__body">
      <ul>
        {tableNames.map((name) => <li>{name}</li>)}
      </ul>
      <hr />
      <dl class="table">
        <div class="table__row">
          <dt>Info</dt>
          <dd>{description}</dd>
        </div>
        <div class="table__row">
          <dt>By</dt>
          <dd><a href={foundryLink}>{foundry}</a></dd>
        </div>
        <div class="table__row">
          <dt>Family</dt>
          <dd>
            {styles}&nbsp;{styles === 1 ? "style" : "styles"}&nbsp;{
              variable ? "+ variable" : ""
            }
          </dd>
        </div>
        {
          /* If variable true, show the axes from the array */
          variable && (
            <div class="table__row">
              <dt>Axes</dt>
              <dd>
                <ul class="list-reset features">
                  {fontAxes.map((axis) => (
                    <li class="feature">{axis}&nbsp;</li>
                  ))}
                </ul>
              </dd>
            </div>
          )
        }
        <div class="table__row">
          <dt>Features</dt>
          <dd>
            <ul class="list-reset features">
              {
                uniqueFeatures.map((feature) => (
                  <li class="feature">{feature}&nbsp;</li>
                  // make sure the last item doesn't have a comma after it
                ))
              }
            </ul>
            {
              /*
            <ul class="list-reset features">
              {
                uniqueFeatures.map((feature) => (
                  <li class="feature">{feature.value}&nbsp;</li>
                ))
              }
            </ul>
            */
            }
          </dd>
        </div>
        <div class="table__row">
          <dt>Download</dt>
          <dd><a href={downloadLink}>{downloadLinkShort}</a></dd>
        </div>
        <div class="table__row">
          <dt>License</dt>
          <dd>{license}</dd>
        </div>
        <div class="table__row">
          <dt>Added</dt>
          <dd>{date}</dd>
        </div>
      </dl>
      {
        /* <div class="flow"> <div> <h2 class="color-meta">Designed By</h2>
        <p> <a href={foundryLink}>{foundry}</a> </p> </div> <div> <h2
        class="color-meta">Family</h2> <p> {styles}&nbsp;{styles === 1 ? "style"
        : "styles"}&nbsp;{ variable ? "+ variable" : " static" } </p> </div>
        <div> <h2 class="color-meta">Licence</h2> <p> {license} </p> </div>
        <div> <h2 class="color-meta">{featureAmount} features</h2> <ul
        class="list-reset features"> { features.map((feature) => ( <li
        class="features__item">{feature}</li> )) } </ul> </div> </div> <div
        class="flow max-width-m"> <slot /> <p> <a class="download"
        href={downloadLink} target="_blank" rel="noopener noreferrer" > Download
        </a> </p> </div> */
      }
    </div>
  </main>
</BaseLayout>
